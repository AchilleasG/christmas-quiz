<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Christmas Quiz - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #0f1b2b;
      --card: #14253a;
      --accent: #e74c3c;
      --muted: #c7d6e5;
    }
    body { font-family: Arial, sans-serif; background: var(--bg); color: #f5f8fb; margin: 0; }
    header { background: #1c3350; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; }
    main { padding: 16px; display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .card { background: var(--card); border-radius: 10px; padding: 14px; box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
    input, textarea, select { width: 100%; padding: 10px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #2a3f59; background: #0f2033; color: #fff; }
    button { background: var(--accent); border: none; color: #fff; padding: 10px 12px; border-radius: 6px; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .pill { background: #1f3550; padding: 6px 10px; border-radius: 14px; font-size: 12px; color: var(--muted); }
    .list { max-height: 240px; overflow: auto; }
    .quiz-item { padding: 8px; border: 1px solid #24405f; border-radius: 8px; margin-bottom: 6px; }
    .question-block { background: #0f2033; padding: 8px; border-radius: 8px; margin-bottom: 8px; }
    .state-box { background: #0f2033; padding: 10px; border-radius: 8px; min-height: 120px; }
    .timer { font-size: 20px; font-weight: bold; color: #f6d36b; }
    .nav { display: flex; gap: 8px; margin-bottom: 8px; }
  </style>
</head>
<body>
<header>
  <div>Christmas Quiz – Admin</div>
  <div class="pill" id="session-label">No session</div>
</header>

<main>
  <div class="nav" style="grid-column: 1 / -1;">
    <button id="nav-dashboard">Dashboard</button>
    <button id="nav-quiz">New Quiz</button>
    <button id="nav-question">Question Editor</button>
    <button id="nav-sessions">Sessions</button>
  </div>

  <section class="card" id="view-dashboard" style="grid-column: 1 / -1;">
    <h3>Dashboard</h3>
    <div class="row">
      <div style="flex:1">
        <div><strong>Quizzes</strong></div>
        <div class="list" id="quiz-list"></div>
        <button id="refresh-quizzes">Refresh</button>
      </div>
      <div style="flex:1">
        <div><strong>Sessions</strong></div>
        <div class="list" id="session-list"></div>
        <button id="refresh-sessions">Refresh</button>
      </div>
    </div>
  </section>

  <section class="card" id="view-quiz" style="display:none; grid-column: 1 / -1;">
    <h3>Create Quiz</h3>
    <input id="quiz-name" placeholder="Quiz name">
    <textarea id="quiz-desc" placeholder="Description (optional)"></textarea>
    <input id="quiz-gap" type="number" value="3" min="0" placeholder="Gap seconds between questions">
    <div id="questions"></div>
    <div class="row">
      <button id="add-question">Add question</button>
      <button id="save-quiz">Save quiz</button>
    </div>
    <div id="quiz-status" class="pill"></div>
    <div id="quiz-detail" style="margin-top:12px; display:none;">
      <h4>Selected quiz</h4>
      <div id="quiz-detail-meta"></div>
      <div id="quiz-detail-questions" class="list"></div>
      <div class="row">
        <button id="quiz-refresh-detail">Refresh</button>
      </div>
    </div>
  </section>

  <section class="card" id="view-question" style="display:none; grid-column: 1 / -1;">
    <h3>Add Question</h3>
    <input id="q-text" placeholder="Question text">
    <input id="q-images" placeholder="Image URLs (comma separated)">
    <input id="q-audio" placeholder="Audio URLs (comma separated)">
    <select id="q-type">
      <option value="multiple_choice">Multiple choice</option>
      <option value="numeric">Numeric</option>
      <option value="text">Text</option>
    </select>
    <input id="q-options" placeholder="Options (for multiple choice)">
    <input id="q-correct" placeholder="Correct answer (must match an option for multiple choice)">
    <select id="q-scoring">
      <option value="exact">Exact match</option>
      <option value="closest">Closest (numeric)</option>
    </select>
    <label style="display:block; margin:6px 0;">
      <input type="checkbox" id="q-speed-bonus"> Speed bonus (faster = more points)
    </label>
    <input id="q-duration" type="number" value="30" min="5" placeholder="Duration seconds">
    <button id="add-question-to-quiz">Add to quiz draft</button>
    <div class="pill" id="question-status"></div>
  </section>

  <section class="card" id="view-sessions" style="display:none; grid-column: 1 / -1;">
    <h3>Sessions</h3>
    <div class="row">
      <input id="session-name" placeholder="Session name">
      <button id="create-session">Create session</button>
      <button id="session-clear-path">Clear path</button>
    </div>
    <div class="row">
      <div style="flex:1">
        <div><strong>Available quizzes</strong></div>
        <div class="list" id="session-quiz-pool"></div>
      </div>
      <div style="flex:1">
        <div><strong>Session path (use arrows to reorder)</strong></div>
        <div class="list" id="session-quiz-path"></div>
      </div>
    </div>
    <div class="list" id="session-list-manage"></div>
    <div class="pill" id="session-status"></div>
    <h4>Control</h4>
    <div class="row">
      <input id="control-session-id" placeholder="Session ID">
      <button id="load-session">Load</button>
      <button id="start-session">Start</button>
      <button id="toggle-manual">Toggle manual</button>
      <button id="next-question">Next</button>
    </div>
    <div class="pill" id="control-status"></div>
    <div class="state-box" id="state-box"></div>
  </section>
</main>

<script>
  const questionsEl = document.getElementById("questions");
  const quizStatus = document.getElementById("quiz-status");
  const quizList = document.getElementById("quiz-list");
  const sessionList = document.getElementById("session-list");
  const sessionListManage = document.getElementById("session-list-manage");
  const sessionLabel = document.getElementById("session-label");
  const controlStatus = document.getElementById("control-status");
  const stateBox = document.getElementById("state-box");
  const quizDetail = document.getElementById("quiz-detail");
  const quizDetailMeta = document.getElementById("quiz-detail-meta");
  const quizDetailQuestions = document.getElementById("quiz-detail-questions");
  const questionStatus = document.getElementById("question-status");
  const questionButton = document.getElementById("add-question-to-quiz");
  const sessionPathEl = document.getElementById("session-quiz-path");
  const sessionPoolEl = document.getElementById("session-quiz-pool");
  const sessionStatus = document.getElementById("session-status");
  let controlSessionId = "";
  let manual = false;
  let ws;
  let questionsDraft = [];
  let currentQuizId = null;
  let currentQuizQuestions = [];
  let editingQuestionId = null;
  let sessionQuizPath = [];
  let quizCache = [];

  function splitList(text) {
    return text.split(",").map(s => s.trim()).filter(Boolean);
  }

  // Quiz draft rendering
  function renderQuestionsDraft() {
    questionsEl.innerHTML = "";
    questionsDraft.forEach((q, idx) => {
      const div = document.createElement("div");
      div.className = "question-block";
      div.innerHTML = `Q${idx + 1}: ${q.text || "(no text)"} (${q.answer_type}) – ${q.duration_seconds || 30}s – speed bonus: ${q.speed_bonus ? "on" : "off"}`;
      questionsEl.appendChild(div);
    });
  }

  function startNewQuizDraft() {
    currentQuizId = null;
    currentQuizQuestions = [];
    editingQuestionId = null;
    document.getElementById("quiz-name").value = "";
    document.getElementById("quiz-desc").value = "";
    document.getElementById("quiz-gap").value = 3;
    questionsDraft = [];
    renderQuestionsDraft();
    quizDetail.style.display = "none";
    quizStatus.textContent = "";
    setQuestionButtonLabel();
  }

  // Session path builder
  function renderSessionPool() {
    sessionPoolEl.innerHTML = "";
    quizCache.forEach(q => {
      const row = document.createElement("div");
      row.className = "quiz-item";
      row.innerHTML = `<strong>${q.name}</strong><br><small>${q.id}</small><br>${q.questions.length} questions`;
      const addBtn = document.createElement("button");
      addBtn.textContent = sessionQuizPath.find(item => item.id === q.id) ? "Added" : "Add";
      addBtn.disabled = !!sessionQuizPath.find(item => item.id === q.id);
      addBtn.onclick = () => {
        if (sessionQuizPath.find(item => item.id === q.id)) return;
        sessionQuizPath.push({id: q.id, name: q.name});
        renderSessionPool();
        renderSessionPath();
      };
      row.appendChild(addBtn);
      sessionPoolEl.appendChild(row);
    });
  }

  function renderSessionPath() {
    sessionPathEl.innerHTML = "";
    sessionQuizPath.forEach((q, idx) => {
      const row = document.createElement("div");
      row.className = "quiz-item";
      row.innerHTML = `<strong>${idx + 1}.</strong> ${q.name} <small>${q.id}</small>`;
      const btns = document.createElement("div");
      btns.className = "row";
      const up = document.createElement("button");
      up.textContent = "Up";
      up.disabled = idx === 0;
      up.onclick = () => {
        if (idx === 0) return;
        [sessionQuizPath[idx - 1], sessionQuizPath[idx]] = [sessionQuizPath[idx], sessionQuizPath[idx - 1]];
        renderSessionPath();
      };
      const down = document.createElement("button");
      down.textContent = "Down";
      down.disabled = idx === sessionQuizPath.length - 1;
      down.onclick = () => {
        if (idx === sessionQuizPath.length - 1) return;
        [sessionQuizPath[idx + 1], sessionQuizPath[idx]] = [sessionQuizPath[idx], sessionQuizPath[idx + 1]];
        renderSessionPath();
      };
      const remove = document.createElement("button");
      remove.textContent = "Remove";
      remove.onclick = () => {
        sessionQuizPath = sessionQuizPath.filter(item => item.id !== q.id);
        renderSessionPool();
        renderSessionPath();
      };
      btns.appendChild(up);
      btns.appendChild(down);
      btns.appendChild(remove);
      row.appendChild(btns);
      sessionPathEl.appendChild(row);
    });
    sessionStatus.textContent = sessionQuizPath.length ? `Path length: ${sessionQuizPath.length}` : "";
  }

  function setQuestionButtonLabel() {
    if (editingQuestionId) {
      questionButton.textContent = "Save question";
    } else if (currentQuizId) {
      questionButton.textContent = "Add to quiz";
    } else {
      questionButton.textContent = "Add to quiz draft";
    }
  }

  function resetQuestionForm(statusText = "") {
    document.getElementById("q-text").value = "";
    document.getElementById("q-images").value = "";
    document.getElementById("q-audio").value = "";
    document.getElementById("q-type").value = "multiple_choice";
    document.getElementById("q-options").value = "";
    document.getElementById("q-correct").value = "";
    document.getElementById("q-scoring").value = "exact";
    document.getElementById("q-speed-bonus").checked = false;
    document.getElementById("q-duration").value = 30;
    editingQuestionId = null;
    questionStatus.textContent = statusText;
    setQuestionButtonLabel();
  }

  function populateQuestionForm(question) {
    document.getElementById("q-text").value = question.text || "";
    document.getElementById("q-images").value = (question.images || []).join(", ");
    document.getElementById("q-audio").value = (question.audio || []).join(", ");
    document.getElementById("q-type").value = question.answer_type || "multiple_choice";
    document.getElementById("q-options").value = (question.options || []).join(", ");
    document.getElementById("q-correct").value = question.correct_answer || "";
    document.getElementById("q-scoring").value = question.scoring_type || "exact";
    document.getElementById("q-speed-bonus").checked = !!question.speed_bonus;
    document.getElementById("q-duration").value = question.duration_seconds || 30;
    editingQuestionId = question.id;
    questionStatus.textContent = "Editing existing question";
    setQuestionButtonLabel();
  }

  function questionPayloadFromForm() {
    return {
      text: document.getElementById("q-text").value,
      images: splitList(document.getElementById("q-images").value),
      audio: splitList(document.getElementById("q-audio").value),
      answer_type: document.getElementById("q-type").value,
      options: splitList(document.getElementById("q-options").value),
      correct_answer: document.getElementById("q-correct").value || null,
      scoring_type: document.getElementById("q-scoring").value || "exact",
      speed_bonus: document.getElementById("q-speed-bonus").checked,
      duration_seconds: Number(document.getElementById("q-duration").value) || 30,
    };
  }

  document.getElementById("add-question").onclick = () => {
    editingQuestionId = null;
    questionStatus.textContent = "";
    setQuestionButtonLabel();
    switchView("question");
  };

  questionButton.onclick = async () => {
    const payload = questionPayloadFromForm();
    if (editingQuestionId && currentQuizId) {
      const res = await fetch(`/admin/quizzes/${currentQuizId}/questions/${editingQuestionId}`, {
        method: "PATCH",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (res.ok) {
        resetQuestionForm("Question updated");
        showQuizDetail(currentQuizId);
        switchView("quiz");
      } else {
        questionStatus.textContent = data.detail || "Unable to update question";
      }
      return;
    }

    if (currentQuizId) {
      const res = await fetch(`/admin/quizzes/${currentQuizId}/questions`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
      });
      if (res.ok) {
        questionStatus.textContent = "Added to quiz";
        showQuizDetail(currentQuizId);
        resetQuestionForm(questionStatus.textContent);
      } else {
        questionStatus.textContent = "Failed to add question";
      }
      return;
    }

    questionsDraft.push({...payload, position: questionsDraft.length});
    questionStatus.textContent = "Added to quiz draft";
    renderQuestionsDraft();
    resetQuestionForm(questionStatus.textContent);
    switchView("quiz");
  };

  document.getElementById("save-quiz").onclick = async () => {
    const name = document.getElementById("quiz-name").value.trim();
    const description = document.getElementById("quiz-desc").value.trim();
    const gap = Number(document.getElementById("quiz-gap").value) || 0;
    const questions = questionsDraft.map((q, idx) => ({...q, position: idx}));
    const res = await fetch("/admin/quizzes", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({name, description, gap_seconds: gap, questions})
    });
    if (res.ok) {
      quizStatus.textContent = "Saved!";
      questionsDraft = [];
      renderQuestionsDraft();
      loadQuizzes();
      switchView("dashboard");
    } else {
      quizStatus.textContent = "Error saving quiz";
    }
  };

  async function loadQuizzes() {
    const res = await fetch("/admin/quizzes");
    const data = await res.json();
    quizCache = data;
    quizList.innerHTML = "";
    sessionList.innerHTML = "";
    data.forEach(q => {
      const div = document.createElement("div");
      div.className = "quiz-item";
      div.innerHTML = `<strong>${q.name}</strong> <small>${q.id}</small><br>${q.description || ""}<br>
        <small>${q.questions.length} questions, gap ${q.gap_seconds}s</small>`;
      div.onclick = () => { currentQuizId = q.id; showQuizDetail(q.id); switchView("quiz"); };
      quizList.appendChild(div);
      const opt = document.createElement("div");
      opt.textContent = `${q.name} (${q.id})`;
      sessionList.appendChild(opt);
    });
    renderSessionPool();
  }
  document.getElementById("refresh-quizzes").onclick = loadQuizzes;
  loadQuizzes();

  async function showQuizDetail(id) {
    const res = await fetch(`/admin/quizzes/${id}`);
    if (!res.ok) return;
    const q = await res.json();
    currentQuizId = id;
    currentQuizQuestions = q.questions || [];
    setQuestionButtonLabel();
    quizDetail.style.display = "block";
    quizDetailMeta.innerHTML = `<div><strong>${q.name}</strong> (${q.id})</div><div>${q.description || ""}</div>`;
    renderQuizDetailQuestions(q.questions);
    document.getElementById("quiz-refresh-detail").onclick = () => showQuizDetail(id);
  }

  function renderQuizDetailQuestions(questions) {
    currentQuizQuestions = questions ? questions.slice() : [];
    quizDetailQuestions.innerHTML = "";
    currentQuizQuestions
      .slice()
      .sort((a, b) => (a.position ?? 0) - (b.position ?? 0))
      .forEach((q, idx) => {
        const row = document.createElement("div");
        row.className = "quiz-item";
        row.innerHTML = `
          <div><strong>Q${idx + 1}</strong> ${q.text || "(no text)"} [${q.answer_type}] – ${q.duration_seconds || 30}s</div>
          <div style="font-size:12px; color:#c7d6e5;">Correct: ${q.correct_answer || "-"} | Scoring: ${q.scoring_type || "exact"} | Speed bonus: ${q.speed_bonus ? "on" : "off"}</div>
          <div class="row">
            <button onclick="moveQuestion('${q.id}', -1)">Up</button>
            <button onclick="moveQuestion('${q.id}', 1)">Down</button>
            <button onclick="editQuestion('${q.id}')">Edit</button>
            <button onclick="removeQuestion('${q.id}')">Remove</button>
          </div>
        `;
        quizDetailQuestions.appendChild(row);
      });
  }

  window.moveQuestion = async (questionId, delta) => {
    if (!currentQuizId) return;
    const res = await fetch(`/admin/quizzes/${currentQuizId}`);
    const data = await res.json();
    const ordered = data.questions.sort((a, b) => (a.position ?? 0) - (b.position ?? 0));
    const idx = ordered.findIndex(q => q.id === questionId);
    const swapIdx = idx + delta;
    if (swapIdx < 0 || swapIdx >= ordered.length) return;
    [ordered[idx], ordered[swapIdx]] = [ordered[swapIdx], ordered[idx]];
    const orderIds = ordered.map(q => q.id);
    await fetch(`/admin/quizzes/${currentQuizId}/questions/reorder`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(orderIds),
    });
    showQuizDetail(currentQuizId);
  };

  window.editQuestion = (questionId) => {
    const question = currentQuizQuestions.find(q => q.id === questionId);
    if (!question) return;
    populateQuestionForm(question);
    switchView("question");
  };

  window.removeQuestion = async (questionId) => {
    if (!currentQuizId) return;
    await fetch(`/admin/quizzes/${currentQuizId}/questions/${questionId}`, {method: "DELETE"});
    showQuizDetail(currentQuizId);
  };

  // Sessions CRUD
  document.getElementById("create-session").onclick = async () => {
    const name = document.getElementById("session-name").value.trim();
    if (!sessionQuizPath.length) {
      sessionStatus.textContent = "Pick at least one quiz for the session path";
      return;
    }
    const quizIds = sessionQuizPath.map(q => q.id);
    const res = await fetch("/admin/sessions", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({name, quiz_ids: quizIds})
    });
    const data = await res.json();
    if (res.ok) {
      sessionLabel.textContent = `Session ${data.id}`;
      document.getElementById("control-session-id").value = data.id;
      controlSessionId = data.id;
      controlStatus.textContent = "Session created";
      loadSessions();
      sessionQuizPath = [];
      renderSessionPath();
      renderSessionPool();
    } else {
      controlStatus.textContent = data.detail || "Error creating session";
    }
  };

  document.getElementById("session-clear-path").onclick = () => {
    sessionQuizPath = [];
    renderSessionPath();
    renderSessionPool();
  };

  async function loadSessions() {
    const res = await fetch("/admin/sessions");
    const data = await res.json();
    sessionListManage.innerHTML = "";
    data.forEach(s => {
      const div = document.createElement("div");
      div.className = "quiz-item";
      div.innerHTML = `
        <strong>${s.name}</strong> <small>${s.id}</small><br>Status: ${s.status}<br>
      <button onclick="startExisting('${s.id}')">Start</button>
      <button onclick="resetSession('${s.id}')">Reset</button>
      <button onclick="duplicateSession('${s.id}')">Duplicate</button>
      <button onclick="deleteSession('${s.id}')">Delete</button>
      <button onclick="loadSession('${s.id}')">Load</button>
      <button onclick="revealScores('${s.id}')">Reveal scores</button>
    `;
    sessionListManage.appendChild(div);
  });
}
document.getElementById("refresh-sessions").onclick = loadSessions;
  loadSessions();

  window.startExisting = async (id) => { await fetch(`/admin/sessions/${id}/start`, {method: "POST"}); };
  window.resetSession = async (id) => { await fetch(`/admin/sessions/${id}/reset`, {method: "POST"}); loadSessions(); };
  window.duplicateSession = async (id) => { await fetch(`/admin/sessions/${id}/duplicate`, {method: "POST"}); loadSessions(); };
  window.deleteSession = async (id) => { await fetch(`/admin/sessions/${id}`, {method: "DELETE"}); loadSessions(); };
  window.revealScores = async (id) => {
    const res = await fetch(`/admin/sessions/${id}/reveal_scores?reveal=true`, {method: "POST"});
    if (!res.ok) {
      controlStatus.textContent = "Scores can be revealed only after session finishes.";
    } else {
      controlStatus.textContent = "Scores revealed.";
    }
  };

  window.loadSession = (id) => {
    document.getElementById("control-session-id").value = id;
    controlSessionId = id;
    sessionLabel.textContent = `Session ${id}`;
    startWebSocket();
    switchView("sessions");
  };

  document.getElementById("load-session").onclick = () => {
    controlSessionId = document.getElementById("control-session-id").value.trim();
    if (controlSessionId) {
      sessionLabel.textContent = `Session ${controlSessionId}`;
      controlStatus.textContent = "Loaded";
      startWebSocket();
    }
  };

  document.getElementById("start-session").onclick = async () => {
    if (!controlSessionId) return;
    const res = await fetch(`/admin/sessions/${controlSessionId}/start`, {method: "POST"});
    const data = await res.json();
    if (!res.ok) {
      controlStatus.textContent = data.detail || "Failed to start session";
      return;
    }
    controlStatus.textContent = `Session started (status: ${data.status})`;
    startWebSocket();
  };

  document.getElementById("toggle-manual").onclick = async () => {
    if (!controlSessionId) return;
    manual = !manual;
    await fetch(`/admin/sessions/${controlSessionId}/manual?manual=${manual}`, {method: "POST"});
    controlStatus.textContent = manual ? "Manual override ON" : "Manual override OFF";
  };

  document.getElementById("next-question").onclick = async () => {
    if (!controlSessionId) return;
    await fetch(`/admin/sessions/${controlSessionId}/next`, {method: "POST"});
    controlStatus.textContent = "Advanced to next";
  };

  function renderState(state) {
    if (!state) {
      stateBox.innerHTML = `<div>Status: unknown</div>`;
      return;
    }
    if (state.stage === "quiz_intro" && state.quiz_intro) {
      const intro = state.quiz_intro;
      stateBox.innerHTML = `
        <div>Status: ${state.status} | Manual: ${state.manual_override}</div>
        <div><strong>Up next:</strong> ${intro.quiz_name || "Untitled quiz"}</div>
        <div>${intro.quiz_description || ""}</div>
        <div>${intro.question_count || 0} questions</div>
        <div class="pill">Awaiting Next</div>
      `;
      return;
    }
    if (!state.question) {
      stateBox.innerHTML = `<div>Status: ${state.status}</div><div>No active question</div>`;
      return;
    }
    const q = state.question;
    const remaining = q.remaining_seconds ?? 0;
    stateBox.innerHTML = `
      <div>Status: ${state.status} | Manual: ${state.manual_override}</div>
      <div><strong>Q${(q.question_index ?? 0) + 1}:</strong> ${q.text || "(no text)"}</div>
      <div class="timer">Time left: ${remaining}s</div>
      <div>${q.answer_type}</div>
      <div>${(q.options || []).map(o => `<span class="pill">${o}</span>`).join(" ")}</div>
      <div>${(q.images || []).map(src => `<img src="${src}">`).join("")}</div>
      <div>${(q.audio || []).map(src => `<audio controls src="${src}"></audio>`).join("")}</div>
    `;
  }

  function startWebSocket() {
    if (!controlSessionId) return;
    if (ws) ws.close();
    ws = new WebSocket(`${location.origin.replace("http", "ws")}/ws/admin/${controlSessionId}`);
    ws.onmessage = (evt) => {
      const data = JSON.parse(evt.data);
      if (data.type === "state") renderState(data.state);
    };
    ws.onclose = () => { controlStatus.textContent = "Socket closed"; };
  }

  // View switching
  function switchView(view) {
    document.getElementById("view-dashboard").style.display = view === "dashboard" ? "block" : "none";
    document.getElementById("view-quiz").style.display = view === "quiz" ? "block" : "none";
    document.getElementById("view-question").style.display = view === "question" ? "block" : "none";
    document.getElementById("view-sessions").style.display = view === "sessions" ? "block" : "none";
    setQuestionButtonLabel();
  }
  document.getElementById("nav-dashboard").onclick = () => switchView("dashboard");
  document.getElementById("nav-quiz").onclick = () => { startNewQuizDraft(); switchView("quiz"); };
  document.getElementById("nav-question").onclick = () => { editingQuestionId = null; switchView("question"); };
  document.getElementById("nav-sessions").onclick = () => { switchView("sessions"); loadSessions(); };
  startNewQuizDraft();
  renderSessionPath();
  switchView("dashboard");
</script>
</body>
</html>
