<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Christmas Quiz - Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0b1d2b;
      color: #f4f4f4;
      margin: 0;
      padding: 0;
    }

    header {
      background: #1f3b4d;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    main {
      padding: 16px;
    }

    .card {
      background: #123047;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    button {
      background: #e13f3f;
      border: none;
      color: white;
      padding: 10px 14px;
      border-radius: 6px;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    input,
    select {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #2f4c62;
      background: #0f2639;
      color: white;
    }

    .options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
    }

    .option {
      background: #1f3b4d;
      border: 2px solid #2f536d;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .option.selected {
      border-color: #e13f3f;
      box-shadow: 0 0 0 2px #e13f3f55;
    }

    .option.correct-frame {
      border-color: #28d27c;
      box-shadow: 0 0 0 2px #28d27c55;
    }

    .option.correct-fill {
      background: #1c5238;
    }

    .option.wrong {
      background: #4d1f2a;
      border-color: #e13f3f;
    }

    .media img {
      max-width: 100%;
      border-radius: 8px;
    }

    .timer {
      font-weight: bold;
    }
  </style>
</head>

<body>
  <header>
    <div>Christmas Quiz</div>
    <div id="player-label"></div>
  </header>
  <main>
    <div class="card" id="join-card">
      <div class="input-row">
        <div style="flex:1">
          <div id="sessions-list"></div>
          <button id="refresh-sessions" style="margin-top:6px;">Refresh sessions</button>
        </div>
        <input id="session-id" placeholder="Session code (8 chars)">
        <input id="player-name" placeholder="Your name">
        <select id="reconnect-select">
          <option value="">Reconnect as...</option>
        </select>
        <button id="join-btn">Join</button>
      </div>
      <small id="status"></small>
    </div>

    <div class="card" id="question-card" style="display:none;">
      <div id="question-text"></div>
      <div class="media" id="media"></div>
      <div class="timer" id="timer"></div>
      <div id="answer-area"></div>
      <div id="reveal-area" style="margin-top:8px; color:#cdd7e0;"></div>
      <button id="submit-btn" style="margin-top:12px;">Submit</button>
    </div>

    <div class="card" id="intro-card" style="display:none;">
      <div id="intro-text"></div>
      <div id="intro-meta" style="color:#cdd7e0;"></div>
    </div>

  <div class="card" id="score-card" style="display:none; color:#cdd7e0;">
    <div><strong>Scores</strong></div>
    <div id="scoreboard" style="margin-top:8px;"></div>
  </div>
  </main>

  <script>
    let socket;
    let playerId = null;
    let sessionId = null;
    let latestState = null;
    let selectedAnswer = null;
    let lastSubmittedAnswer = null;
    let lastQuestionId = null;
    let answerResults = {};
    let answerValues = {};

    const statusEl = document.getElementById("status");
    const joinCard = document.getElementById("join-card");
    const joinBtn = document.getElementById("join-btn");
    const sessionsList = document.getElementById("sessions-list");
    const refreshSessions = document.getElementById("refresh-sessions");
    const questionCard = document.getElementById("question-card");
    const introCard = document.getElementById("intro-card");
    const questionText = document.getElementById("question-text");
    const introText = document.getElementById("intro-text");
    const introMeta = document.getElementById("intro-meta");
    const mediaEl = document.getElementById("media");
    const timerEl = document.getElementById("timer");
    const answerArea = document.getElementById("answer-area");
    const revealArea = document.getElementById("reveal-area");
    const submitBtn = document.getElementById("submit-btn");
    const reconnectSelect = document.getElementById("reconnect-select");
    const playerLabel = document.getElementById("player-label");
    const myScoreEl = document.getElementById("my-score");
    const scoreboardEl = document.getElementById("scoreboard");
    const scoreCard = document.getElementById("score-card");

    joinBtn.onclick = () => {
      sessionId = document.getElementById("session-id").value.trim();
      const name = document.getElementById("player-name").value.trim();
      const reconnectAs = reconnectSelect.value || null;
      if (!sessionId) {
        statusEl.textContent = "Enter a session code";
        return;
      }
      startSocket({ name, player_id: reconnectAs });
    };

    submitBtn.onclick = () => {
      if (!socket || socket.readyState !== WebSocket.OPEN || !latestState?.question) return;
      lastSubmittedAnswer = selectedAnswer;
      const payload = { type: "answer", player_id: playerId, answer: selectedAnswer };
      socket.send(JSON.stringify(payload));
      statusEl.textContent = "Answer submitted";
      submitBtn.style.display = "none";
    };

    async function loadSessions() {
      try {
        const res = await fetch("/admin/sessions");
        const data = await res.json();
        sessionsList.innerHTML = data
          .map(s => `<div style="margin-bottom:4px; cursor:pointer;" onclick="pickSession('${s.id}')">${s.name} (${s.id})</div>`)
          .join("");
      } catch {
        sessionsList.innerHTML = "Failed to load sessions";
      }
    }
    refreshSessions.onclick = loadSessions;
    window.pickSession = (id) => {
      document.getElementById("session-id").value = id;
    };
    loadSessions();

    function startSocket({ name, player_id }) {
      if (socket) socket.close();
      socket = new WebSocket(`${location.origin.replace("http", "ws")}/ws/player/${sessionId}`);
      socket.onopen = () => {
        socket.send(JSON.stringify({ type: "join", name, player_id }));
      };
      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "welcome") {
          playerId = data.player.id;
          playerLabel.textContent = `${data.player.name} (${playerId})`;
          statusEl.textContent = "Connected";
          joinCard.style.display = "none";
        }
        if (data.type === "state") {
          latestState = data.state;
          answerResults = latestState.answers || {};
          answerValues = latestState.answer_values || {};
          updateReconnectList(data.state.disconnected_players || []);
          renderState();
        }
      };
      socket.onclose = () => {
        statusEl.textContent = "Disconnected";
        joinCard.style.display = "block";
      };
    }

    function renderState() {
    if (!latestState) {
      questionCard.style.display = "none";
      introCard.style.display = "none";
      scoreCard.style.display = "none";
      return;
      }
      if (latestState.stage === "quiz_intro" && latestState.quiz_intro) {
        const intro = latestState.quiz_intro;
        introCard.style.display = "block";
        questionCard.style.display = "none";
        introText.textContent = `Up next: ${intro.quiz_name || "Untitled quiz"}`;
        introMeta.textContent = `${intro.question_count || 0} questions`;
        return;
      }
      introCard.style.display = "none";
    if (!latestState.question) {
      questionCard.style.display = "none";
      // Show scores only once quiz flow is done
      if (latestState.status === "finished" && latestState.scores_revealed) {
        scoreCard.style.display = "block";
        renderScoreboard();
      } else {
        scoreCard.style.display = "none";
      }
      return;
    }
    if (latestState.status === "finished" && latestState.scores_revealed) {
      scoreCard.style.display = "block";
      renderScoreboard();
    } else {
      scoreCard.style.display = "none";
    }
    const q = latestState.question;
    const renderKey = `${q.id}-${q.revealed ? "revealed" : "open"}`;
    const isNewQuestion = q.id !== lastQuestionId;
    if (isNewQuestion) {
      lastQuestionId = q.id;
      lastSubmittedAnswer = null;
    }
    questionCard.style.display = "block";
    questionText.textContent = q.text || "Untitled question";
    renderMedia(q);
    if (renderKey !== window.__lastRenderKey) {
      renderAnswerArea(q);
      renderReveal(q);
      window.__lastRenderKey = renderKey;
    }
    updateTimer(q);
  }

    function renderScoreboard() {
      const players = latestState?.players || [];
      scoreboardEl.innerHTML = players
        .slice()
        .sort((a, b) => (b.score || 0) - (a.score || 0))
        .map(p => `<div>${p.name || "Player"}: ${p.score || 0} ${!p.connected ? "(disconnected)" : ""}</div>`)
        .join("");
    }

    function renderMedia(q) {
      mediaEl.innerHTML = "";
      (q.images || []).forEach(src => {
        const img = document.createElement("img");
        img.src = src;
        mediaEl.appendChild(img);
      });
      (q.audio || []).forEach(src => {
        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = src;
        mediaEl.appendChild(audio);
      });
    }

  function renderAnswerArea(q) {
    answerArea.innerHTML = "";
    selectedAnswer = lastSubmittedAnswer || null;
    submitBtn.disabled = true;
    submitBtn.style.display = "block";
      if (q.answer_type === "multiple_choice") {
        const wrap = document.createElement("div");
        wrap.className = "options";
        (q.options || []).forEach(opt => {
          const div = document.createElement("div");
          div.className = "option";
          div.textContent = opt;
          const revealed = q.revealed;
          const isCorrect = q.correct_answer && opt === q.correct_answer;
          const isMine = lastSubmittedAnswer && opt === lastSubmittedAnswer;
          if (revealed) {
            if (isCorrect) div.classList.add("correct-frame");
            if (isCorrect && isMine) div.classList.add("correct-fill");
            if (isMine && !isCorrect) div.classList.add("wrong");
          } else {
            div.onclick = () => {
              selectedAnswer = opt;
              document.querySelectorAll(".option").forEach(el => el.classList.remove("selected"));
              div.classList.add("selected");
              submitBtn.disabled = false;
            };
            if (lastSubmittedAnswer && opt === lastSubmittedAnswer) {
              div.classList.add("selected");
              submitBtn.disabled = false;
            }
          }
          wrap.appendChild(div);
        });
        answerArea.appendChild(wrap);
      } else {
        const input = document.createElement("input");
        input.type = q.answer_type === "numeric" ? "number" : "text";
        input.placeholder = "Your answer";
        input.value = lastSubmittedAnswer || "";
        input.disabled = q.revealed;
        input.oninput = (e) => {
          selectedAnswer = e.target.value;
          lastSubmittedAnswer = selectedAnswer;
          submitBtn.disabled = !selectedAnswer;
        };
        answerArea.appendChild(input);
      }

      if (q.revealed) {
        submitBtn.style.display = "none";
      } else {
        submitBtn.disabled = !selectedAnswer;
      }
    }

    function renderReveal(q) {
      revealArea.innerHTML = "";
      if (!q.revealed) return;
      if (q.answer_type === "numeric") {
        const playersById = {};
        (latestState.players || []).forEach(p => { playersById[p.id] = p; });
        revealArea.innerHTML = `<div>Correct answer: ${q.correct_answer || "(not set)"}</div>`;
        const allAnswers = [];
        if (q.scoring_type === "closest") {
          (latestState.closest_results || []).forEach((entry, idx) => {
            const name = playersById[entry.player_id]?.name || entry.player_id || "Player";
            const ansVal = entry.answer ?? "(no answer)";
            allAnswers.push(`${idx + 1}. ${name}: ${ansVal}`);
          });
        } else {
          Object.entries(answerValues || {}).forEach(([pid, ans]) => {
            const name = playersById[pid]?.name || pid || "Player";
            const ansVal = ans ?? "(no answer)";
            allAnswers.push(`${name}: ${ansVal}`);
          });
        }
        if (allAnswers.length) {
          revealArea.innerHTML += `<div style="margin-top:6px;">${allAnswers.join("<br>")}</div>`;
        }
        return;
      }
      const myResult = answerResults[playerId];
      const verdict = myResult === undefined ? "" : myResult ? "You got it right!" : "You got it wrong.";
      revealArea.textContent = `Correct answer: ${q.correct_answer || "(not set)"} ${verdict}`;
    }

    function updateTimer(q) {
    if (!q.closes_at) {
      timerEl.textContent = "";
      return;
    }
    const now = new Date(latestState.now).getTime();
    const closes = new Date(q.closes_at).getTime();
    const remaining = Math.max(0, Math.round((closes - now) / 1000));
    timerEl.textContent = `Time left: ${remaining}s`;
    if (!q.revealed) {
      submitBtn.disabled = remaining <= 0 || !selectedAnswer;
    }
  }

    function updateReconnectList(disconnected) {
      reconnectSelect.innerHTML = '<option value="">Reconnect as...</option>';
      disconnected.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = `${p.name} (${p.id})`;
        reconnectSelect.appendChild(opt);
      });
    }
  </script>
</body>

</html>
